<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.webmanifest">

    <link rel="apple-touch-icon" href="img/icon192.png">
    <meta name="apple-mobile-web-app-status-bar" content="#7386D5">
    <meta name="theme-color" content="#7386D5">

    <link rel="icon" href="img/PWA_Logo.png">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

    <title>PWA1 - WebAPI</title>
</head>
<body>

<div class="jumbotron text-center bg-light">
    <h1>PWA Wizard</h1>
    <br>
    <h3>Web-API</h3>
</div>

<div class="container-fluid">
    <div class="row">
        <div class="col col-2 px-0">
            <nav class="d-flex flex-column flex-shrink-0 p-3 bg-light" >
                <ul class="nav nav-pills flex-column">
                    <li class="nav-item">
                        <a href="index.html" class="nav-link link-dark" aria-current="page">
                            <b>Startseite</b>
                        </a>
                    </li>
                    <li>
                        <a href="pwa0.html" class="nav-link link-dark">
                            <b>Beispiel</b>
                        </a>
                    </li>
                    <li>
                        <a href="Datenbank.html" class="nav-link link-dark">
                            - Datenbank
                        </a>
                    </li>
                    <li>
                        <a href="Funktionsweise.html" class="nav-link link-dark">
                            - Funktionsweise
                        </a>
                    </li>
                    <li>
                        <a href="pwa1.html" class="nav-link link-dark">
                            <b>Installierbare PWA</b>
                        </a>
                    </li>
                    <li>
                        <a href="Manifest.html" class="nav-link link-dark">
                            - Web-App-Manifest
                        </a>
                    </li>
                    <li>
                        <a href="ServiceWorker.html" class="nav-link link-dark">
                            - ServiceWorker
                        </a>
                    </li>
                    <li>
                        <a href="Fallbackpage.html" class="nav-link link-dark">
                            - Fallbackpage
                        </a>
                    </li>
                    <li>
                        <a href="Lighthouse.html" class="nav-link link-dark">
                            - Lighthouse
                        </a>
                    </li>
                    <li>
                        <a href="WebAPI.html" class="nav-link active">
                            - Web-API
                        </a>
                    </li>
                    <li>
                        <a href="pwa2.html" class="nav-link link-dark">
                            <b>Read-Only PWA</b>
                        </a>
                    </li>
                    <li>
                        <a href="Cache-Strategie.html" class="nav-link link-dark">
                            - Cache-Strategie
                        </a>
                    </li>
                    <li>
                        <a href="Dynamisches-Cachen.html" class="nav-link link-dark">
                            - Dynamisches Cachen
                        </a>
                    </li>
                    <li>
                        <a href="pwa3.html" class="nav-link link-dark">
                            <b>Read-Write PWA</b>
                        </a>
                    </li>
                    <li>
                        <a href="IndexedDB.html" class="nav-link link-dark">
                            - IndexedDB
                        </a>
                    </li>
                </ul>
            </nav>
        </div>

        <div class="col col-1"></div>

        <div class="col col-6 mb-4 mt-0 bg-light">

            <div class="float-right mt-3">
                <button type="button" onclick="location.href='Datenbank.html'" style="border: #f3f3f3; background-color: #f3f3f3">
                    Github
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-github" viewBox="0 0 16 16">
                        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
                    </svg>
                </button>
            </div>

            Am Beispiel der Push-Benachrichtigungen wird nun die Verwendung von Web-APIs in Progressive Web Apps erläutert.
            Im Beispiel der Personentabelle werden die Push-Benachrichtigungen jedes mal gesendet, wenn eine Person hinzugefügt, geändert oder gelöscht wird.
            <br>
            <br>
            <h4>Datenbank</h4>
            Zuerst muss die Datenbank um eine Tabelle, die der Abonnenten (subscribers), erweitert werden.
            Dort werden alle Nutzer eingetragen, die sich für die Benachrichtigungen registriert haben.
            <br>
            <br>
            <h5>Spalten der Abonnenten (Subscribers):</h5>
            <ul>
                <li><b>ID:</b> Die eindeutige ID des Abonnenten</li>
                <li><b>endpoint:</b> Verwaltet die Zustellung der Benachrichtigung an den Browser</li>
                <li><b>auth:</b> Wird vom Browser bereitgestellt und authentifiziert den Nutzer</li>
                <li><b>p256dh:</b> Dieser Schlüssel wird als Teil des Abonnements zurückgegeben</li>
            </ul>
            <br>
            <br>
            <h4>PushNotifications-Model:</h4>
            Neben der Datenbank muss ebenfalls ein neues Model (PushNotificationsModel) hinzugefügt werden,
            welches die Daten behandelt, die für die Push-Benachrichtigungen notwendig sind.
            Dieses enthält Funktionen um neue Abonnenten hinzuzufügen, diese zu aktualisieren,
            zu entfernen und um alle Abonnenten der Tabelle ausgegeben zu bekommen.

            <div class="border border-primary mb-2 mt-2"><pre><code>
// Abonnenten hinzufuegen, Prinzip beim loeschen und bearbeiten gleich
public function insertSubscriber($endpoint, $auth, $p256dh){
    $data = [
        'endpoint' => $endpoint,
        'auth' => $auth,
        'p256dh' => $p256dh
    ];
    $this->_subscribers->insert($data);
    return true;
}

// Alle Abonnenten der Datenbank erhalten
public function getAllSubscribers(){
    return $this->_subscribers->get()->getResult();
}

//Nutzer durch dessen endpoint ausfindig machen
public function getSubscribersByEndpoint($endpoint){
    return $this->_subscribers
        ->where("endpoint", $endpoint)
        ->get()
        ->getResult();
}
        </code></pre></div>
            <br>
            <br>
            <h4>People-Controller:</h4>
            Die Funktionen für das Hinzufügen, Löschen und Bearbeiten von Personen der Tabelle müssen erweitert werden,
            da jedes mal eine Nachricht gesendet werden soll, wenn eine Änderung an der Personentabelle vorgenommen wird.
            <br>
            Aus diesem Grund werden als erstes über die Funktion <i><b>getAllSubscribers</b></i> aus dem Model alle Abonnenten in die Variable <i><b>$subscribers</b></i> eingelesen.
            <br>
            Danach werden in die Variable <i><b>$keys_auth</b></i> alle Informationen der Abonnenten gespeichert, an die die Nachricht gesendet werden soll.


            <div class="border border-primary mb-2 mt-2"><pre><code>
$subscribers = $this->_pushNotificationsModel->getAllSubscribers();

foreach ($subscribers as $row){

    $keys_auth = array(
        "contentEncoding" => "aesgcm",
        "endpoint" => $row->endpoint,
        "keys" => array(
            "auth" => $row->auth,
            "p256dh" => $row->p256dh
        )
    );

    $message = "added";

    $this->sendMessage($keys_auth, $row->endpoint, $message, $this->request->getVar('new-prename'),  $this->request->getVar('new-surname'));
        </code></pre></div>

            Innerhalb der foreach-Schleife wird dann mit jedem Subscriber die Funktion sendMessage aufgerufen.
            <br>
            Die <i><b>sendMessage</b></i>-Funktion erstellt die Nachricht, die angezeigt werden soll sowie das WebPush Objekt und versendet schlussendlich die Nachricht.
            <br>
            Die <i><b>push_subscription</b></i>-Funktion besteht aus einem switch-case und ruft, je nach Aktion, die dazugehörige Funktion des Models auf,
            die dann die Person zu den Abonnenten hinzufügt, löscht oder bearbeitet.

            <br>
            <br>
            <h4>People-View:</h4>
            Nach der Anpassung der Datenbank und des Controllers muss nun als drittes den Views ein Button hinzugefügt werden,
            auf den die Nutzer klicken können, um sich für die Push-Benachrichtigungen zu registrieren.
            <div class="border border-primary mb-2 mt-2"><pre><code>
&ltbutton id="pushButton" class="btn btn-primary mr-2 d-flex justify-content-center align-items-center"&gtPush on&lt/button&gt
        </code></pre></div>
            Im Beispiel wurde dies mittels eines Button gelöst.
            Eine andere Möglichkeit ist das Anzeigen eines Popup-Fensters, indem der Nutzer die Benachrichtigungen aktivieren kann.

            <br>
            <br>
            <h4>app.js:</h4>
            Die app.js-Datei fragt ab, ob ein <i><b>push</b></i>-Button im Dokument gesetzt ist, registriert diesen daraufhin im ServiceWorker
            und durch die <i><b>registration.pushManager.getSubscription</b></i>-Funktionen kann der Nutzer nun Nachrichten vom Server erhalten.
            Als weiteres muss die app.js einen <i><b>click</b></i>-Event-Listener enthalten, der auf das Klicken des Benutzers auf den Push-Button horcht.

            <div class="border border-primary mb-2 mt-2"><pre><code>
const pushButton = document.getElementById('pushButton');

    if (pushButton !== null) {
        navigator.serviceWorker.ready
            .then(serviceWorkerRegistration =>
                serviceWorkerRegistration.pushManager.getSubscription())
            .then(subscription => {
                console.log("Subscription: " + JSON.stringify(subscription));
                if (subscription === null) {
                    pushButton.textContent = 'Allow Push';
                } else {
                    pushButton.textContent = 'Stop Push';
                }
            });


        pushButton.addEventListener('click', () => {
            navigator.serviceWorker.ready
                .then(serviceWorkerRegistration =>
                    serviceWorkerRegistration.pushManager.getSubscription())
                .then(subscription => {
                    if (subscription === null) {
                        push_subscribe()
                            .then(res => {
                                console.log("subscribe: " + res);
                            });
                        pushButton.textContent = 'Stop Push';
                    } else {
                        if (confirm("are you sure you want to unsubscribe?")) {
                            push_unsubscribe();
                            pushButton.textContent = 'Allow Push'
                        }
                    }
                });
        });
    }
        </code></pre></div>

            Besteht zum Zeitpunkt des Klicks auf den Button noch kein Abonnement, so wird die <i><b>push_subscribe</b></i>-Methode aufgerufen.
            <div class="border border-primary mb-2 mt-2"><pre><code>
function push_subscribe() {
    return checkNotificationPermission()
        .then(() => navigator.serviceWorker.ready)
        .then(serviceWorkerRegistration =>
            serviceWorkerRegistration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array(applicationServerKey)
            })
        )
        .then(subscription => {
            return push_sendSubscriptionToServer(subscription, 'POST');
        })
        .then(subscription => {
            isPushEnabled = true;
        })
        .catch(e => {
            if (Notification.permission === 'denied') {
                console.warn('Notifications are denied by the user.');
            } else {
                console.error('Impossible to subscribe to push notifications', e);
            }
        });
}
        </code></pre></div>

            Die <i><b>push_subscribe</b></i>-Methode fragt daraufhin über die <i><b>checkNotificationPermission</b></i>-Methode ab, ob Push-Benachrichtigungen
            vom Nutzer erlaubt/aktiviert worden sind.
            Sind diese aktiviert worden, so wird der <i><b>applicationServerKey</b></i> über die <i><b>urlBase64ToUint8Array</b></i>-Methode erzeugt,
            um damit die Unterstützung von Chrome zu garantieren.

            <div class="border border-primary mb-2 mt-2"><pre><code>
function push_sendSubscriptionToServer(subscription, method) {
    const key = subscription.getKey('p256dh');
    const token = subscription.getKey('auth');
    const contentEncoding = (PushManager.supportedContentEncodings || ['aesgcm'])[0];

    return fetch('http://localhost/people/push_subscription', {
        method,
        mode: "same-origin",
        credentials: "same-origin",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            "endpoint": subscription.endpoint,
            "publicKey": key ? btoa(String.fromCharCode.apply(null, new Uint8Array(key))) : null,
            "authToken": token ? btoa(String.fromCharCode.apply(null, new Uint8Array(token))) : null,
            contentEncoding
        }),
    }).then(() => subscription);
}
        </code></pre></div>

            Als letztes wird das Abonnement mit allen gegebenen Parametern, also dem publicKey, dem authToken und dem endpoint mit Hilfe der
            <i><b>push_sendSubscriptionToServer</b></i>-Methode als JSON durch die Verwendung von <i><b>fetch</b></i> an den Server gesendet.
            <br>
            Die Methode push_unsubscribe der app.js-Datei macht das Abonnement rückgängig.

            <br>
            <br>
            <h4>ServiceWorker:</h4>
            Da nun der Push der Nachrichten fertiggestellt ist, ist es nun nur noch notwendig, die Nachrichten über den ServiceWorker zu erstellen
            und danach auf dem Bildschirm des Nutzers auszugeben.
            Dafür wird der ServiceWorker um 2 Funktionen erweitert.
            Der ServiceWorker horcht mit Hilfe eines <i><b>push</b></i>-EventListener auf einen Push, erstellt daraufhin die Nachricht und
            zeigt diese über die Funktion <i><b>showNotification</b></i> an.

            <div class="border border-primary mb-2 mt-2"><pre><code>
self.addEventListener('push', event => {
    if (!(self.Notification && self.Notification.permission === 'granted')){
        return;
    }

    const sendNotification = (body) => {
        var data = JSON.parse(body);

        const title = data.title;

        return self.registration.showNotification(title, {
            body: data.body,
            icon: data.icon,
            badge: data.badge,
            image: data.image,
            data: {
                url: data.url
            }
        });
    };

    if (event.data) {
        const message = event.data.text();
        event.waitUntil(sendNotification(message));
    }
})
        </code></pre></div>

            <div class="border border-primary mb-2 mt-2"><pre><code>
self.addEventListener('notificationclick', event => {
    console.log(('[Service Worker] Notification click received.'));
    event.notification.close();

    const url = event.notification.data.url;
    console.log(url);

    event.waitUntil(clients.matchAll({
        type: 'window'
    }).then(clientList => {
        console.log(clientList);
        for (let i = 0; i < clientList.length; i++) {
            let client = clientList[i];
            if (client.url === self.registration.scope && 'focus' in client) {
                return client.focus();
            }
        }
        if (clients.openWindow){
            return clients.openWindow(url);
        }
    }));
})
        </code></pre></div>

            Die zweite Funktion, die im ServiceWorker implementiert werden muss, wird ausgelöst, wenn der Nutzer auf den Banner der Push-Nachricht klickt.
            Dabei wird das <i><b>notificationclick</b></i>-Event ausgelöst, welches im Beispiel beinhaltet, dass die Webseite aufgerufen wird.




            <br>
            <br>
            <button type="button" onclick="location.href='WebAPI.html'" class="btn btn-primary">Nach oben</button>

            <div class="float-right">
                <button type="button" onclick="location.href='pwa2.html'" class="btn btn-primary">Read-Only PWA <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-forward-fill" viewBox="0 0 16 16">
                    <path d="m9.77 12.11 4.012-2.953a.647.647 0 0 0 0-1.114L9.771 5.09a.644.644 0 0 0-.971.557V6.65H2v3.9h6.8v1.003c0 .505.545.808.97.557z"/>
                </svg></button>
            </div>

            <br>
            <br>

        </div>

        <div class="col col-3"></div>
    </div>
</div>

<script src="app.js"></script>

</body>
</html>